<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Reset password â€” ToDoList</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 520px; margin: 40px auto; padding: 0 16px; }
        .card { border: 1px solid #ddd; border-radius: 12px; padding: 18px; }
        input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin: 8px 0 14px; }
        button { padding: 10px 14px; border: 0; border-radius: 8px; background: #111; color: #fff; cursor: pointer; }
        button:disabled { opacity: .6; cursor: default; }
        .msg { margin-top: 12px; padding: 10px; border-radius: 8px; background: #f5f5f5; white-space: pre-wrap; }
    </style>
</head>
<body>
<h2>Reset password</h2>

<div class="card">
    <label>New password</label>
    <input id="newPassword" type="password" minlength="6" placeholder="At least 6 characters" required />

    <button id="btn">Set new password</button>
    <div id="msg" class="msg" style="display:none;"></div>
</div>

<script>
    const API_BASE = "https://todolist-api-cxb9bufjb8hpcvh8.polandcentral-01.azurewebsites.net";

    const params = new URLSearchParams(window.location.search);
    const token = params.get("token");

    const btn = document.getElementById("btn");
    const msg = document.getElementById("msg");

    if (!token) {
        msg.textContent = "Missing token. Please open the reset link from your email.";
        msg.style.display = "block";
        btn.disabled = true;
    }

    btn.addEventListener("click", async () => {
        const newPassword = document.getElementById("newPassword").value;
        if (!newPassword || newPassword.length < 6) {
            msg.textContent = "Password must be at least 6 characters.";
            msg.style.display = "block";
            return;
        }

        btn.disabled = true;
        msg.style.display = "none";

        try {
            const res = await fetch(`${API_BASE}/api/auth/reset-password`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ token, newPassword })
            });

            if (res.status === 204 || res.ok) {
                msg.textContent = "Your password has been updated. You can now log in.";
                msg.style.display = "block";
            } else {
                let text = "";
                try { text = await res.text(); } catch (e) {}
                msg.textContent =
                    "Reset link is invalid or expired. Please request a new one.\n\n" +
                    (text ? ("Server said: " + text) : "");
                msg.style.display = "block";
            }
        } catch (e) {
            msg.textContent = "Something went wrong. Please try again later.\n" + (e?.message || "");
            msg.style.display = "block";
        } finally {
            btn.disabled = false;
        }
    });
</script>
</body>
</html>