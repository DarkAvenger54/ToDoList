<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ToDoList API — Full Test UI</title>
    <style>
        :root{
            --bg:#0b1020;
            --panel:#111a33;
            --card:#0f1730;
            --text:#e7ecff;
            --muted:#b6c0ffb8;
            --line:#24305a;
            --ok:#2ee67b;
            --bad:#ff5c5c;
            --warn:#ffd166;
            --btn:#1a2550;
            --btn2:#162046;
            --chip:#1b2755;
            --shadow: 0 14px 30px rgba(0,0,0,.35);
            --radius:14px;
            --radius2:18px;
        }

        *{ box-sizing:border-box; }
        body{
            margin:0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
            background: radial-gradient(1200px 600px at 20% -10%, #1b2a66 0%, transparent 60%),
            radial-gradient(900px 600px at 90% 0%, #2a1b66 0%, transparent 55%),
            var(--bg);
            color: var(--text);
        }

        .wrap{ max-width: 1200px; margin: 0 auto; padding: 22px 16px 48px; }

        .topbar{
            display:flex; align-items:flex-start; justify-content:space-between;
            gap:12px; margin-bottom:16px;
        }
        h1{
            margin:0;
            font-size: 22px;
            letter-spacing:.2px;
        }
        .subtitle{ color: var(--muted); margin-top:6px; font-size:13px; line-height:1.35; }
        .pill{
            display:inline-flex; align-items:center; gap:8px;
            padding: 6px 10px; border-radius:999px;
            background: rgba(255,255,255,.06);
            border:1px solid rgba(255,255,255,.10);
            font-size:12px; color: var(--muted);
        }
        .dot{ width:8px; height:8px; border-radius:50%; background:#666; }
        .dot.ok{ background: var(--ok); }
        .dot.bad{ background: var(--bad); }

        .grid{
            display:grid;
            grid-template-columns: 1.1fr .9fr;
            gap:14px;
            align-items:start;
        }
        @media (max-width: 980px){
            .grid{ grid-template-columns:1fr; }
        }

        .card{
            background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
            border: 1px solid rgba(255,255,255,.10);
            border-radius: var(--radius2);
            padding: 14px;
            box-shadow: var(--shadow);
        }

        .section-title{
            display:flex; align-items:center; justify-content:space-between;
            gap:10px;
            margin:0 0 10px 0;
            font-size:15px;
            letter-spacing:.2px;
        }
        .section-title small{ color: var(--muted); font-weight: 500; font-size: 12px; }

        .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
        .col{ flex:1; min-width: 260px; }
        label{ display:block; font-size:12px; color: var(--muted); margin:10px 0 6px; }
        input, textarea, select{
            width:100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.14);
            background: rgba(0,0,0,.18);
            color: var(--text);
            outline:none;
        }
        textarea{ min-height: 86px; resize: vertical; }
        input::placeholder, textarea::placeholder{ color: rgba(231,236,255,.45); }

        .btns{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
        button{
            padding: 9px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.16);
            background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
            color: var(--text);
            cursor:pointer;
            transition: transform .06s ease, background .12s ease, border-color .12s ease;
            user-select:none;
        }
        button:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.24); }
        button:active{ transform: translateY(1px); }
        .btn-sm{ padding: 7px 10px; font-size: 12px; border-radius: 12px; }
        .btn-blue{ border-color: rgba(70,160,255,.45); }
        .btn-green{ border-color: rgba(46,230,123,.45); }
        .btn-red{ border-color: rgba(255,92,92,.50); }
        .btn-warn{ border-color: rgba(255,209,102,.55); }

        .hint{
            margin-top:8px;
            font-size:12px;
            color: var(--muted);
            line-height:1.35;
        }
        code{
            padding: 2px 7px;
            border-radius: 999px;
            background: rgba(255,255,255,.08);
            border: 1px solid rgba(255,255,255,.12);
            color: var(--text);
            font-size: 12px;
        }

        .hr{ height:1px; background: rgba(255,255,255,.10); margin: 12px 0; }

        .status{
            display:flex; align-items:center; justify-content:space-between; gap:10px;
            padding: 10px 12px;
            border-radius: var(--radius);
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(0,0,0,.18);
            margin-bottom:10px;
        }
        .status .left{ display:flex; align-items:center; gap:10px; }
        .status .msg{ font-size: 13px; color: var(--muted); }
        .status .msg strong{ color: var(--text); }
        .badge-ok{ color: var(--ok); font-weight: 800; }
        .badge-bad{ color: var(--bad); font-weight: 900; }

        pre{
            margin:0;
            padding: 12px;
            border-radius: var(--radius2);
            border: 1px solid rgba(255,255,255,.10);
            background: rgba(0,0,0,.30);
            color: #d7e0ff;
            overflow:auto;
            max-height: 520px;
        }

        .table{
            width:100%;
            border-collapse: collapse;
            border-radius: var(--radius2);
            overflow:hidden;
            border: 1px solid rgba(255,255,255,.10);
            background: rgba(0,0,0,.22);
        }
        .table th, .table td{
            border-bottom: 1px solid rgba(255,255,255,.08);
            padding: 10px 10px;
            text-align:left;
            font-size: 13px;
            vertical-align: top;
        }
        .table th{ color: var(--muted); font-size: 12px; font-weight: 700; }
        .table tr:hover td{ background: rgba(255,255,255,.04); }

        .kpi{ display:flex; gap:10px; flex-wrap:wrap; }
        .kpi .pill{ background: rgba(255,255,255,.05); }

        .two-col{
            display:grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }
        @media (max-width: 700px){
            .two-col{ grid-template-columns: 1fr; }
        }

        .mini-card{
            border:1px dashed rgba(255,255,255,.18);
            border-radius: var(--radius2);
            padding: 10px;
            background: rgba(0,0,0,.18);
        }

        .right .card{ position: sticky; top: 14px; }
        @media (max-width: 980px){
            .right .card{ position: static; }
        }

        .danger{
            color: var(--warn);
            font-size:12px;
        }
    </style>
</head>

<body>
<div class="wrap">
    <div class="topbar">
        <div>
            <h1>ToDoList API — Full Test UI</h1>
            <div class="subtitle">
                Всё в одном файле: Auth, Personal Tasks, Friends, Groups, Group Invites, Group Tasks, Notifications, AI.
                <br/>JWT хранится в <code>localStorage</code> → заголовок <code>Authorization: Bearer &lt;jwt&gt;</code>
            </div>
        </div>

        <div class="kpi">
            <span class="pill"><span id="authDot" class="dot"></span><span id="authState">not logged</span></span>
            <span class="pill">API: <span id="apiBadge" style="color:var(--text)"></span></span>
        </div>
    </div>

    <div class="grid">
        <!-- LEFT: controls -->
        <div class="left">

            <!-- 0 Settings -->
            <div class="card">
                <div class="section-title">
                    <div>0) Настройки</div>
                    <small>локально: http://localhost:8085</small>
                </div>

                <div class="row">
                    <div class="col">
                        <label>API_BASE</label>
                        <input id="apiBase" value="http://localhost:8085" />
                    </div>
                    <div class="col">
                        <label>JWT</label>
                        <input id="jwt" placeholder="paste jwt here" />
                    </div>
                </div>

                <div class="btns">
                    <button onclick="loadState()">Load</button>
                    <button onclick="saveState()">Save</button>
                    <button class="btn-sm btn-red" onclick="clearJwt()">Clear JWT</button>
                    <button class="btn-sm btn-blue" onclick="hello()">Ping auth (hello)</button>
                </div>

                <div class="hint">
                    Если backend отдаёт этот HTML как static — просто открой <code>/test-ui.html</code>.
                </div>
            </div>

            <!-- 1 Auth -->
            <div class="card">
                <div class="section-title">
                    <div>1) Auth</div>
                    <small>register/login + confirm/resend + reset</small>
                </div>

                <div class="two-col">
                    <div>
                        <label>Register: username</label>
                        <input id="regUsername" placeholder="john" />
                        <label>Register: email</label>
                        <input id="regEmail" placeholder="john@example.com" />
                        <label>Register: password</label>
                        <input id="regPassword" type="password" placeholder="secret123" />
                        <div class="btns">
                            <button class="btn-blue" onclick="register()">POST /api/auth/register</button>
                        </div>
                    </div>

                    <div>
                        <label>Login: login (username or email)</label>
                        <input id="loginLogin" placeholder="john or john@example.com" />
                        <label>Login: password</label>
                        <input id="loginPassword" type="password" placeholder="secret123" />
                        <div class="btns">
                            <button class="btn-blue" onclick="login()">POST /api/auth/login</button>
                        </div>

                        <div class="hr"></div>

                        <label>Resend confirmation: email</label>
                        <input id="resendEmail" placeholder="john@example.com" />
                        <div class="btns">
                            <button onclick="resendConfirm()">POST /api/auth/resend-confirmation</button>
                        </div>

                        <div class="hr"></div>

                        <label>Forgot password: email</label>
                        <input id="fpEmail" placeholder="john@example.com" />
                        <div class="btns">
                            <button onclick="forgotPassword()">POST /api/auth/forgot-password</button>
                        </div>

                        <label>Reset password: token</label>
                        <input id="rpToken" placeholder="paste token from email" />
                        <label>Reset password: newPassword</label>
                        <input id="rpNewPassword" type="password" placeholder="newSecret123" />
                        <div class="btns">
                            <button onclick="resetPassword()">POST /api/auth/reset-password</button>
                        </div>
                    </div>
                </div>

                <div class="hint danger">
                    В твоём UserDetailsService стоит проверка emailVerified → логин без подтверждения вернёт 403.
                </div>
            </div>

            <!-- 2 Personal Tasks -->
            <div class="card">
                <div class="section-title">
                    <div>2) Personal Tasks</div>
                    <small>/api/tasks</small>
                </div>

                <div class="two-col">
                    <div>
                        <label>title</label>
                        <input id="tTitle" placeholder="Buy milk" />
                        <label>description</label>
                        <textarea id="tDesc" placeholder="optional"></textarea>
                        <div class="row">
                            <div class="col">
                                <label>priority</label>
                                <select id="tPriority">
                                    <option value="">(null)</option>
                                    <option>LOW</option>
                                    <option selected>MEDIUM</option>
                                    <option>HIGH</option>
                                    <option>URGENT</option>
                                </select>
                            </div>
                            <div class="col">
                                <label>dueAt (ISO LocalDateTime)</label>
                                <input id="tDueAt" placeholder="2026-02-05T18:00:00" />
                            </div>
                        </div>
                        <div class="btns">
                            <button class="btn-blue" onclick="createTask()">POST /api/tasks</button>
                        </div>
                    </div>

                    <div>
                        <div class="row">
                            <div class="col">
                                <label>List status</label>
                                <select id="listStatus">
                                    <option value="">(all)</option>
                                    <option>TODO</option>
                                    <option>IN_PROGRESS</option>
                                    <option>DONE</option>
                                    <option>CANCELLED</option>
                                </select>
                            </div>
                            <div class="col">
                                <label>page</label>
                                <input id="page" value="0" />
                            </div>
                            <div class="col">
                                <label>size</label>
                                <input id="size" value="10" />
                            </div>
                        </div>
                        <div class="btns">
                            <button onclick="listTasks()">GET /api/tasks</button>
                            <button class="btn-sm" onclick="renderPageFromLast('tasks')">Render last</button>
                        </div>

                        <div class="hr"></div>

                        <label>Task ID</label>
                        <input id="taskId" placeholder="e.g. 1" />
                        <div class="btns">
                            <button onclick="getTask()">GET /api/tasks/{id}</button>
                            <button class="btn-sm btn-red" onclick="deleteTask()">DELETE /api/tasks/{id}</button>
                        </div>

                        <div class="hr"></div>

                        <label>Update title</label>
                        <input id="uTitle" placeholder="optional" />
                        <label>Update description</label>
                        <textarea id="uDesc" placeholder="optional"></textarea>

                        <div class="row">
                            <div class="col">
                                <label>Update status</label>
                                <select id="uStatus">
                                    <option value="">(null)</option>
                                    <option>TODO</option>
                                    <option>IN_PROGRESS</option>
                                    <option>DONE</option>
                                    <option>CANCELLED</option>
                                </select>
                            </div>
                            <div class="col">
                                <label>Update priority</label>
                                <select id="uPriority">
                                    <option value="">(null)</option>
                                    <option>LOW</option>
                                    <option>MEDIUM</option>
                                    <option>HIGH</option>
                                    <option>URGENT</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col">
                                <label>Update dueAt (ISO)</label>
                                <input id="uDueAt" placeholder="optional" />
                            </div>
                            <div class="col">
                                <label>clearDueAt</label>
                                <select id="uClearDueAt">
                                    <option value="">(null)</option>
                                    <option value="true">true</option>
                                    <option value="false">false</option>
                                </select>
                            </div>
                        </div>

                        <div class="btns">
                            <button class="btn-blue" onclick="updateTask()">PUT /api/tasks/{id}</button>
                        </div>
                    </div>
                </div>

                <div class="mini-card" id="tasksTable">
                    <div class="muted">Нажми <b>GET /api/tasks</b> — таблица появится тут.</div>
                </div>
            </div>

            <!-- 3 Friends -->
            <div class="card">
                <div class="section-title">
                    <div>3) Friends</div>
                    <small>/api/friends</small>
                </div>

                <div class="row">
                    <div class="col">
                        <label>Target username</label>
                        <input id="frUsername" placeholder="friendUser" />
                        <div class="btns">
                            <button class="btn-blue" onclick="sendFriendRequest()">POST /api/friends/request</button>
                        </div>
                    </div>

                    <div class="col">
                        <label>Friendship request id (accept)</label>
                        <input id="frAcceptId" placeholder="id" />
                        <div class="btns">
                            <button class="btn-green" onclick="acceptFriendRequest()">POST /api/friends/accept/{id}</button>
                        </div>
                    </div>

                    <div class="col">
                        <label>Friendship id (remove)</label>
                        <input id="frRemoveId" placeholder="id" />
                        <div class="btns">
                            <button class="btn-red" onclick="removeFriend()">DELETE /api/friends/{id}</button>
                        </div>
                    </div>

                    <div class="col" style="min-width:220px">
                        <label>&nbsp;</label>
                        <div class="btns">
                            <button onclick="listFriends()">GET /api/friends</button>
                            <button class="btn-sm" onclick="renderFriendsFromLast()">Render last</button>
                        </div>
                    </div>
                </div>

                <div class="mini-card" id="friendsTable">
                    <div class="muted">Нажми <b>GET /api/friends</b> — таблица появится тут.</div>
                </div>
            </div>

            <!-- 4 Groups -->
            <div class="card">
                <div class="section-title">
                    <div>4) Groups</div>
                    <small>/api/groups</small>
                </div>

                <div class="two-col">
                    <div>
                        <label>Create group name</label>
                        <input id="gName" placeholder="My Group" />
                        <div class="btns">
                            <button class="btn-blue" onclick="createGroup()">POST /api/groups</button>
                            <button onclick="myGroups()">GET /api/groups</button>
                            <button class="btn-sm" onclick="renderGroupsFromLast()">Render last</button>
                        </div>

                        <div class="mini-card" id="groupsTable" style="margin-top:10px">
                            <div class="muted">Нажми <b>GET /api/groups</b> — список появится тут.</div>
                        </div>
                    </div>

                    <div>
                        <label>Group ID</label>
                        <input id="gId" placeholder="e.g. 1" />

                        <label>Rename group name (OWNER)</label>
                        <input id="gRename" placeholder="New name" />
                        <div class="btns">
                            <button onclick="renameGroup()">PUT /api/groups/{id}/name</button>
                            <button onclick="groupMembers()">GET /api/groups/{id}/members</button>
                        </div>

                        <div class="hr"></div>

                        <label><b>Invite user</b> (OWNER)</label>
                        <input id="gInviteUser" placeholder="username" />
                        <div class="btns">
                            <button class="btn-blue" onclick="inviteMember()">POST /api/groups/{id}/invites/{username}</button>
                        </div>

                        <div class="hr"></div>

                        <label>Set role: username</label>
                        <input id="gRoleUser" placeholder="username" />
                        <label>Set role: role</label>
                        <select id="gRole">
                            <option>ADMIN</option>
                            <option selected>MEMBER</option>
                        </select>
                        <div class="btns">
                            <button onclick="setRole()">PUT /api/groups/{id}/role</button>
                        </div>
                    </div>
                </div>

                <div class="mini-card" id="membersTable" style="margin-top:10px">
                    <div class="muted">Нажми <b>GET /api/groups/{id}/members</b> — таблица появится тут.</div>
                </div>
            </div>

            <!-- 4.1 Group Invites -->
            <div class="card">
                <div class="section-title">
                    <div>4.1) Group Invites</div>
                    <small>/api/group-invites</small>
                </div>

                <div class="two-col">
                    <div>
                        <div class="btns">
                            <button onclick="listMyInvites()">GET /api/group-invites/mine</button>
                            <button class="btn-sm" onclick="renderInvitesFromLastResponse()">Render last</button>
                        </div>
                        <div class="hint">Показывает только <b>PENDING</b>.</div>

                        <div class="hr"></div>

                        <label>Invite ID (accept/reject)</label>
                        <input id="invId" placeholder="inviteId" />
                        <div class="btns">
                            <button class="btn-green" onclick="acceptInvite()">POST /api/group-invites/{id}/accept</button>
                            <button class="btn-red" onclick="rejectInvite()">POST /api/group-invites/{id}/reject</button>
                        </div>

                        <div class="hr"></div>

                        <label>Notification ID (если inviteId не знаешь)</label>
                        <input id="invNotifId" placeholder="notificationId" />
                        <div class="btns">
                            <button class="btn-sm" onclick="fetchNotificationAndExtractRefId()">
                                Fetch notifications & extract inviteId
                            </button>
                        </div>
                        <div class="hint">refId = inviteId (если notifyUser так сделал при invite).</div>
                    </div>

                    <div>
                        <div class="muted" style="margin-bottom:8px">Invites table</div>
                        <div id="invTable" class="mini-card">
                            <div class="muted">Нажми <b>GET /api/group-invites/mine</b> — таблица появится тут.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5 Group Tasks -->
            <div class="card">
                <div class="section-title">
                    <div>5) Group Tasks</div>
                    <small>/api/groups/{groupId}/tasks</small>
                </div>

                <div class="row">
                    <div class="col">
                        <label>Group ID</label>
                        <input id="gtGroupId" placeholder="e.g. 1" />

                        <div class="hr"></div>

                        <h3 style="margin:0 0 6px; font-size:14px">ADMIN/OWNER: assign to user</h3>
                        <label>assigneeUsername</label>
                        <input id="gtAssignee" placeholder="username" />
                        <label>title</label>
                        <input id="gtTitle" placeholder="Do something" />
                        <label>description</label>
                        <textarea id="gtDesc"></textarea>

                        <div class="row">
                            <div class="col">
                                <label>priority</label>
                                <select id="gtPriority">
                                    <option value="">(null)</option>
                                    <option>LOW</option>
                                    <option selected>MEDIUM</option>
                                    <option>HIGH</option>
                                    <option>URGENT</option>
                                </select>
                            </div>
                            <div class="col">
                                <label>dueAt (ISO)</label>
                                <input id="gtDueAt" placeholder="optional" />
                            </div>
                            <div class="col">
                                <label>visibleInGroup</label>
                                <select id="gtVisible">
                                    <option value="true" selected>true</option>
                                    <option value="false">false</option>
                                </select>
                            </div>
                        </div>

                        <div class="btns">
                            <button class="btn-blue" onclick="assignGroupTask()">POST /api/groups/{id}/tasks/assign</button>
                        </div>
                    </div>

                    <div class="col">
                        <h3 style="margin:0 0 6px; font-size:14px">ADMIN/OWNER: create for all</h3>
                        <label>title</label>
                        <input id="gaTitle" placeholder="Group task" />
                        <label>description</label>
                        <textarea id="gaDesc"></textarea>

                        <div class="row">
                            <div class="col">
                                <label>priority</label>
                                <select id="gaPriority">
                                    <option value="">(null)</option>
                                    <option>LOW</option>
                                    <option selected>MEDIUM</option>
                                    <option>HIGH</option>
                                    <option>URGENT</option>
                                </select>
                            </div>
                            <div class="col">
                                <label>dueAt (ISO)</label>
                                <input id="gaDueAt" placeholder="optional" />
                            </div>
                        </div>

                        <div class="btns">
                            <button class="btn-blue" onclick="createForAll()">POST /api/groups/{id}/tasks/for-all</button>
                        </div>

                        <div class="hr"></div>

                        <h3 style="margin:0 0 6px; font-size:14px">ADMIN/OWNER: change groupTask status</h3>
                        <div class="row">
                            <div class="col">
                                <label>taskId</label>
                                <input id="gsTaskId" placeholder="taskId" />
                            </div>
                            <div class="col">
                                <label>status</label>
                                <select id="gsStatus">
                                    <option>TODO</option>
                                    <option>IN_PROGRESS</option>
                                    <option selected>DONE</option>
                                    <option>CANCELLED</option>
                                </select>
                            </div>
                        </div>
                        <div class="btns">
                            <button onclick="setGroupTaskStatus()">POST /api/groups/{id}/tasks/{taskId}/status</button>
                        </div>

                        <div class="hr"></div>

                        <h3 style="margin:0 0 6px; font-size:14px">ADMIN/OWNER: update / delete group task</h3>
                        <label>taskId</label>
                        <input id="guTaskId" placeholder="taskId" />
                        <label>title</label>
                        <input id="guTitle" placeholder="optional" />
                        <label>description</label>
                        <textarea id="guDesc" placeholder="optional"></textarea>

                        <div class="row">
                            <div class="col">
                                <label>status</label>
                                <select id="guStatus">
                                    <option value="">(null)</option>
                                    <option>TODO</option>
                                    <option>IN_PROGRESS</option>
                                    <option>DONE</option>
                                    <option>CANCELLED</option>
                                </select>
                            </div>
                            <div class="col">
                                <label>priority</label>
                                <select id="guPriority">
                                    <option value="">(null)</option>
                                    <option>LOW</option>
                                    <option>MEDIUM</option>
                                    <option>HIGH</option>
                                    <option>URGENT</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col">
                                <label>dueAt (ISO) or empty</label>
                                <input id="guDueAt" placeholder="optional" />
                            </div>
                            <div class="col">
                                <label>clearDueAt</label>
                                <select id="guClearDueAt">
                                    <option value="">(null)</option>
                                    <option value="true">true</option>
                                    <option value="false">false</option>
                                </select>
                            </div>
                            <div class="col">
                                <label>visibleInGroup</label>
                                <select id="guVisible">
                                    <option value="">(null)</option>
                                    <option value="true">true</option>
                                    <option value="false">false</option>
                                </select>
                            </div>
                        </div>

                        <div class="btns">
                            <button class="btn-blue" onclick="updateGroupTask()">PUT /api/groups/{id}/tasks/{taskId}</button>
                            <button class="btn-red" onclick="deleteGroupTask()">DELETE /api/groups/{id}/tasks/{taskId}</button>
                        </div>

                        <div class="hr"></div>

                        <h3 style="margin:0 0 6px; font-size:14px">MEMBER: lists</h3>
                        <div class="row">
                            <div class="col">
                                <label>page</label>
                                <input id="gtPage" value="0" />
                            </div>
                            <div class="col">
                                <label>size</label>
                                <input id="gtSize" value="10" />
                            </div>
                        </div>
                        <div class="btns">
                            <button onclick="groupMine()">GET /mine</button>
                            <button onclick="groupForAllList()">GET /for-all/list</button>
                            <button onclick="groupVisible()">GET /visible</button>
                            <button class="btn-sm" onclick="renderPageFromLast('groupTasks')">Render last</button>
                        </div>
                    </div>
                </div>

                <div class="mini-card" id="groupTasksTable" style="margin-top:10px">
                    <div class="muted">Нажми любой list endpoint — таблица появится тут.</div>
                </div>
            </div>

            <!-- 6 Notifications -->
            <div class="card">
                <div class="section-title">
                    <div>6) Notifications</div>
                    <small>/api/notifications</small>
                </div>

                <div class="row">
                    <div class="col">
                        <label>unreadOnly</label>
                        <select id="nUnreadOnly">
                            <option value="true" selected>true</option>
                            <option value="false">false</option>
                        </select>
                    </div>
                    <div class="col">
                        <label>page</label>
                        <input id="nPage" value="0" />
                    </div>
                    <div class="col">
                        <label>size</label>
                        <input id="nSize" value="10" />
                    </div>
                </div>

                <div class="btns">
                    <button onclick="listNotifications()">GET /api/notifications</button>
                    <button onclick="unreadCount()">GET /api/notifications/unread-count</button>
                    <button class="btn-sm" onclick="renderPageFromLast('notifications')">Render last</button>
                </div>

                <div class="hr"></div>

                <div class="row">
                    <div class="col">
                        <label>notificationId</label>
                        <input id="nId" placeholder="id" />
                    </div>
                    <div class="col" style="min-width:260px">
                        <label>&nbsp;</label>
                        <div class="btns">
                            <button onclick="markRead()">POST /mark-read</button>
                            <button class="btn-sm btn-warn" onclick="markAllRead()">POST /mark-all-read</button>
                        </div>
                    </div>
                </div>

                <div class="mini-card" id="notificationsTable" style="margin-top:10px">
                    <div class="muted">Нажми <b>GET /api/notifications</b> — таблица появится тут.</div>
                </div>
            </div>

            <!-- 7 AI -->
            <div class="card">
                <div class="section-title">
                    <div>7) AI Tasks</div>
                    <small>/api/ai/tasks/suggest</small>
                </div>

                <label>command</label>
                <textarea id="aiCommand" placeholder="Например: Сгенерируй 5 задач на сегодня: учеба, спорт, покупки"></textarea>

                <div class="row">
                    <div class="col">
                        <label>scope</label>
                        <select id="aiScope">
                            <option value="PERSONAL" selected>PERSONAL</option>
                            <option value="GROUP">GROUP</option>
                        </select>
                    </div>
                    <div class="col">
                        <label>groupId (только для GROUP)</label>
                        <input id="aiGroupId" placeholder="e.g. 1" />
                    </div>
                    <div class="col">
                        <label>maxTasks</label>
                        <input id="aiMaxTasks" value="5" />
                    </div>
                </div>

                <div class="btns">
                    <button class="btn-blue" onclick="aiSuggest()">POST /api/ai/tasks/suggest</button>
                    <button class="btn-sm" onclick="aiFillExample()">Fill example</button>
                    <button class="btn-sm" onclick="renderAiFromLastResponse()">Render last</button>
                </div>

                <div class="hr"></div>

                <div class="btns">
                    <button class="btn-green" onclick="aiCreateSelected()">Create selected (SAVE to DB)</button>
                    <button class="btn-sm" onclick="aiSelectAll(true)">Select all</button>
                    <button class="btn-sm" onclick="aiSelectAll(false)">Unselect all</button>
                </div>

                <div class="hint">
                    PERSONAL → <code>POST /api/tasks</code>, GROUP → <code>POST /api/groups/{id}/tasks/for-all</code>
                </div>

                <div class="mini-card" id="aiTable" style="margin-top:10px">
                    <div class="muted">Нажми <b>POST /api/ai/tasks/suggest</b> — предложения появятся тут.</div>
                </div>
            </div>

        </div>

        <!-- RIGHT: response viewer -->
        <div class="right">
            <div class="card">
                <div class="section-title">
                    <div>Response</div>
                    <small>last call</small>
                </div>

                <div class="status" id="statusLine">
                    <div class="left">
                        <span class="pill">status</span>
                        <div class="msg"><strong>—</strong></div>
                    </div>
                    <div class="btns" style="margin:0">
                        <button class="btn-sm" onclick="copyOut()">Copy JSON</button>
                        <button class="btn-sm" onclick="clearOut()">Clear</button>
                    </div>
                </div>

                <pre id="out">{}</pre>

                <div class="hint">
                    Совет: если что-то падает с 401/403 — проверь JWT и emailVerified.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function $(id){ return document.getElementById(id); }

    let lastResponse = null;
    let lastAiSuggestions = []; // tasks[] from AI rendered list

    // ===== Settings / Auth state =====
    function apiBase() {
        return $("apiBase").value.trim().replace(/\/+$/, "");
    }

    function setAuthState() {
        const jwt = $("jwt").value.trim();
        $("authState").textContent = jwt ? "logged" : "not logged";
        $("authDot").className = "dot " + (jwt ? "ok" : "");
        $("apiBadge").textContent = apiBase();
    }

    function loadState() {
        $("apiBase").value = localStorage.getItem("apiBase") || $("apiBase").value;
        $("jwt").value = localStorage.getItem("jwt") || "";
        setAuthState();
        ok("Loaded");
    }

    function saveState() {
        localStorage.setItem("apiBase", $("apiBase").value.trim());
        localStorage.setItem("jwt", $("jwt").value.trim());
        setAuthState();
        ok("Saved");
    }

    function clearJwt() {
        localStorage.removeItem("jwt");
        $("jwt").value = "";
        setAuthState();
        ok("JWT cleared");
    }

    function authHeaders() {
        const jwt = $("jwt").value.trim();
        const h = { "Content-Type": "application/json" };
        if (jwt) h["Authorization"] = "Bearer " + jwt;
        return h;
    }

    // ===== Response UI =====
    function ok(msg) {
        $("statusLine").innerHTML = `
      <div class="left">
        <span class="pill"><span class="badge-ok">OK</span></span>
        <div class="msg"><strong>${escapeHtml(msg)}</strong></div>
      </div>
      <div class="btns" style="margin:0">
        <button class="btn-sm" onclick="copyOut()">Copy JSON</button>
        <button class="btn-sm" onclick="clearOut()">Clear</button>
      </div>
    `;
    }

    function showResponse(method, path, res, data) {
        const status = res.ok ? "OK" : "ERROR";
        const line = `${method} ${path} → ${res.status} ${status}`;
        $("statusLine").innerHTML = `
      <div class="left">
        <span class="pill">${res.ok ? '<span class="badge-ok">OK</span>' : '<span class="badge-bad">ERROR</span>'}</span>
        <div class="msg"><strong>${escapeHtml(line)}</strong></div>
      </div>
      <div class="btns" style="margin:0">
        <button class="btn-sm" onclick="copyOut()">Copy JSON</button>
        <button class="btn-sm" onclick="clearOut()">Clear</button>
      </div>
    `;

        $("out").textContent = (typeof data === "string")
            ? data
            : JSON.stringify(data, null, 2);
    }

    function clearOut(){
        $("out").textContent = "{}";
        ok("Cleared output");
    }

    async function copyOut(){
        try{
            await navigator.clipboard.writeText($("out").textContent || "");
            ok("Copied");
        }catch(e){
            ok("Copy failed (browser permissions)");
        }
    }

    // ===== Core request =====
    async function request(method, path, body) {
        setAuthState();
        const url = apiBase() + path;
        const opts = { method, headers: authHeaders() };
        if (body !== undefined) opts.body = JSON.stringify(body);

        const res = await fetch(url, opts);
        const text = await res.text();

        let data;
        try { data = text ? JSON.parse(text) : null; }
        catch { data = text; }

        lastResponse = data;
        showResponse(method, path, res, data);

        if (!res.ok) throw new Error(`${method} ${path} -> ${res.status}`);
        return data;
    }

    function escapeHtml(s) {
        return String(s ?? "").replace(/[&<>"']/g, (c) => ({
            "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
        }[c]));
    }

    // ===== Generic render helpers =====
    function renderTable(containerId, columns, rows) {
        const box = $(containerId);
        if (!Array.isArray(rows) || rows.length === 0) {
            box.innerHTML = `<div class="muted">Нет данных.</div>`;
            return;
        }
        const thead = columns.map(c => `<th>${escapeHtml(c.label)}</th>`).join("");
        const tbody = rows.map(r => {
            const tds = columns.map(c => `<td>${c.render(r)}</td>`).join("");
            return `<tr>${tds}</tr>`;
        }).join("");
        box.innerHTML = `
      <table class="table">
        <thead><tr>${thead}</tr></thead>
        <tbody>${tbody}</tbody>
      </table>
    `;
    }

    function renderPageFromLast(kind){
        // kind: tasks | groupTasks | notifications
        if (!lastResponse || typeof lastResponse !== "object") {
            ok("Last response is empty/not object");
            return;
        }
        // Expect Spring Page: {content:[...], number, size, totalElements, totalPages, ...}
        if (!Array.isArray(lastResponse.content)) {
            ok("Last response is not Page{content:[]}");
            return;
        }
        if (kind === "tasks") renderTasksPage(lastResponse, "tasksTable");
        if (kind === "groupTasks") renderTasksPage(lastResponse, "groupTasksTable");
        if (kind === "notifications") renderNotificationsPage(lastResponse);
    }

    function renderTasksPage(page, containerId){
        const content = page.content || [];
        renderTable(containerId,
            [
                { label: "id", render: t => escapeHtml(t.id) },
                { label: "title", render: t => `<b>${escapeHtml(t.title)}</b><div class="muted" style="margin-top:4px">${escapeHtml(t.description||"")}</div>` },
                { label: "status", render: t => escapeHtml(t.status) },
                { label: "priority", render: t => escapeHtml(t.priority) },
                { label: "scope", render: t => escapeHtml(t.scope) },
                { label: "dueAt", render: t => escapeHtml(t.dueAt || "") },
                { label: "group", render: t => t.groupId ? `${escapeHtml(t.groupName||"")} <span class="muted">(#${escapeHtml(t.groupId)})</span>` : "" },
                { label: "assignee", render: t => escapeHtml(t.assigneeUsername || "") },
                { label: "flags", render: t => `${t.groupTask ? "groupTask" : ""}${t.visibleInGroup ? (t.groupTask ? ", visible" : "visible") : ""}` },
                { label: "actions", render: t =>
                        `<div class="btns" style="margin:0">
             <button class="btn-sm" onclick="fillTaskId(${Number(t.id)})">Use ID</button>
           </div>`
                }
            ],
            content
        );
        ok(`Rendered ${content.length} item(s). page=${page.number}, size=${page.size}, total=${page.totalElements}`);
    }

    function fillTaskId(id){
        $("taskId").value = String(id);
        $("guTaskId").value = String(id);
        $("gsTaskId").value = String(id);
        ok("Inserted taskId into fields");
    }

    // ===== Auth endpoints =====
    async function register() {
        await request("POST", "/api/auth/register", {
            username: $("regUsername").value.trim(),
            email: $("regEmail").value.trim(),
            password: $("regPassword").value
        });
    }

    async function login() {
        const data = await request("POST", "/api/auth/login", {
            login: $("loginLogin").value.trim(),
            password: $("loginPassword").value
        });
        $("jwt").value = data.jwtToken || "";
        saveState();
    }

    async function resendConfirm() {
        await request("POST", "/api/auth/resend-confirmation", { email: $("resendEmail").value.trim() });
    }

    async function forgotPassword() {
        await request("POST", "/api/auth/forgot-password", { email: $("fpEmail").value.trim() });
    }

    async function resetPassword() {
        await request("POST", "/api/auth/reset-password", {
            token: $("rpToken").value.trim(),
            newPassword: $("rpNewPassword").value
        });
    }

    async function hello() {
        await request("GET", "/api/v1/poctaserwis/test/hello");
    }

    // ===== Personal tasks =====
    async function createTask() {
        await request("POST", "/api/tasks", {
            title: $("tTitle").value.trim(),
            description: $("tDesc").value.trim() || null,
            priority: $("tPriority").value || null,
            dueAt: $("tDueAt").value.trim() || null
        });
    }

    async function listTasks() {
        const qs = new URLSearchParams();
        if ($("listStatus").value) qs.set("status", $("listStatus").value);
        qs.set("page", $("page").value.trim() || "0");
        qs.set("size", $("size").value.trim() || "10");
        const data = await request("GET", "/api/tasks?" + qs.toString());
        renderTasksPage(data, "tasksTable");
    }

    async function getTask() {
        const id = $("taskId").value.trim();
        await request("GET", `/api/tasks/${id}`);
    }

    async function updateTask() {
        const id = $("taskId").value.trim();
        const clearDueAtRaw = $("uClearDueAt").value;
        const clearDueAt = clearDueAtRaw === "" ? null : (clearDueAtRaw === "true");

        await request("PUT", `/api/tasks/${id}`, {
            title: $("uTitle").value.trim() || null,
            description: $("uDesc").value.trim() || null,
            status: $("uStatus").value || null,
            priority: $("uPriority").value || null,
            dueAt: $("uDueAt").value.trim() || null,
            clearDueAt
        });
    }

    async function deleteTask() {
        const id = $("taskId").value.trim();
        await request("DELETE", `/api/tasks/${id}`);
    }

    // ===== Friends =====
    async function sendFriendRequest() {
        await request("POST", "/api/friends/request", { username: $("frUsername").value.trim() });
    }

    async function acceptFriendRequest() {
        const id = $("frAcceptId").value.trim();
        await request("POST", `/api/friends/accept/${id}`);
    }

    async function removeFriend() {
        const id = $("frRemoveId").value.trim();
        await request("DELETE", `/api/friends/${id}`);
    }

    async function listFriends() {
        const data = await request("GET", "/api/friends");
        renderFriends(data);
    }

    function renderFriendsFromLast(){
        renderFriends(lastResponse);
    }

    function renderFriends(list){
        renderTable("friendsTable",
            [
                { label:"id", render: x => escapeHtml(x.id) },
                { label:"username", render: x => `<b>${escapeHtml(x.username)}</b>` },
                { label:"email", render: x => escapeHtml(x.email) },
                { label:"actions", render: x => `
          <div class="btns" style="margin:0">
            <button class="btn-sm" onclick="setFriendRemove(${Number(x.id)})">Use removeId</button>
          </div>`
                }
            ],
            Array.isArray(list) ? list : []
        );
        ok("Rendered friends");
    }

    function setFriendRemove(id){
        $("frRemoveId").value = String(id);
        ok("Inserted friendship id");
    }

    // ===== Groups =====
    async function createGroup() {
        await request("POST", "/api/groups", { name: $("gName").value.trim() });
    }

    async function myGroups() {
        const data = await request("GET", "/api/groups");
        renderGroups(data);
    }

    function renderGroupsFromLast(){
        renderGroups(lastResponse);
    }

    function renderGroups(list){
        renderTable("groupsTable",
            [
                { label:"id", render: g => escapeHtml(g.id) },
                { label:"name", render: g => `<b>${escapeHtml(g.name)}</b>` },
                { label:"owner", render: g => escapeHtml(g.ownerUsername) },
                { label:"actions", render: g => `
          <div class="btns" style="margin:0">
            <button class="btn-sm" onclick="useGroupId(${Number(g.id)})">Use groupId</button>
            <button class="btn-sm" onclick="useGroupIdAll(${Number(g.id)})">Use in all modules</button>
          </div>`
                }
            ],
            Array.isArray(list) ? list : []
        );
        ok("Rendered groups");
    }

    function useGroupId(id){
        $("gId").value = String(id);
        ok("Inserted groupId");
    }

    function useGroupIdAll(id){
        $("gId").value = String(id);
        $("gtGroupId").value = String(id);
        $("aiGroupId").value = String(id);
        ok("Inserted groupId into Groups/GroupTasks/AI");
    }

    async function renameGroup() {
        const id = $("gId").value.trim();
        await request("PUT", `/api/groups/${id}/name`, { name: $("gRename").value.trim() });
    }

    async function groupMembers() {
        const id = $("gId").value.trim();
        const data = await request("GET", `/api/groups/${id}/members`);
        renderMembers(data);
    }

    function renderMembers(list){
        renderTable("membersTable",
            [
                { label:"userId", render: m => escapeHtml(m.userId) },
                { label:"username", render: m => `<b>${escapeHtml(m.username)}</b>` },
                { label:"email", render: m => escapeHtml(m.email) },
                { label:"role", render: m => escapeHtml(m.role) },
                { label:"actions", render: m => `
          <div class="btns" style="margin:0">
            <button class="btn-sm" onclick="fillMemberUsername('${escapeJs(m.username)}')">Use username</button>
          </div>`
                }
            ],
            Array.isArray(list) ? list : []
        );
        ok("Rendered members");
    }

    function escapeJs(s){
        return String(s ?? "").replace(/\\/g,"\\\\").replace(/'/g,"\\'");
    }

    function fillMemberUsername(username){
        $("gInviteUser").value = username;
        $("gRoleUser").value = username;
        $("gtAssignee").value = username;
        ok("Inserted username into fields");
    }

    async function inviteMember() {
        const id = $("gId").value.trim();
        const username = $("gInviteUser").value.trim();
        await request("POST", `/api/groups/${id}/invites/${encodeURIComponent(username)}`);
    }

    async function setRole() {
        const id = $("gId").value.trim();
        await request("PUT", `/api/groups/${id}/role`, {
            username: $("gRoleUser").value.trim(),
            role: $("gRole").value
        });
    }

    // ===== Group Invites =====
    async function listMyInvites() {
        const data = await request("GET", "/api/group-invites/mine");
        renderInvitesTable(data);
    }

    function renderInvitesFromLastResponse() {
        renderInvitesTable(lastResponse);
    }

    function renderInvitesTable(invites) {
        const box = $("invTable");
        if (!Array.isArray(invites) || invites.length === 0) {
            box.innerHTML = `<div class="muted">Нет pending invites.</div>`;
            return;
        }
        const rows = invites.map(i => `
      <tr>
        <td>${escapeHtml(String(i.id ?? ""))}</td>
        <td>${escapeHtml(String(i.groupName ?? ""))} <span class="muted">(#${escapeHtml(String(i.groupId ?? ""))})</span></td>
        <td>${escapeHtml(String(i.inviterUsername ?? ""))}</td>
        <td>${escapeHtml(String(i.status ?? ""))}</td>
        <td>
          <div class="btns" style="margin:0">
            <button class="btn-sm btn-green" onclick="acceptInviteQuick(${Number(i.id)})">Accept</button>
            <button class="btn-sm btn-red" onclick="rejectInviteQuick(${Number(i.id)})">Reject</button>
            <button class="btn-sm" onclick="copyInviteId(${Number(i.id)})">Use</button>
            <button class="btn-sm" onclick="useGroupIdAll(${Number(i.groupId)})">Use groupId</button>
          </div>
        </td>
      </tr>
    `).join("");
        box.innerHTML = `
      <table class="table">
        <thead>
          <tr>
            <th>inviteId</th>
            <th>group</th>
            <th>inviter</th>
            <th>status</th>
            <th>actions</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    }

    function copyInviteId(id) {
        $("invId").value = String(id);
        ok("Invite ID inserted");
    }

    async function acceptInviteQuick(id) {
        $("invId").value = String(id);
        await acceptInvite();
        await listMyInvites();
    }

    async function rejectInviteQuick(id) {
        $("invId").value = String(id);
        await rejectInvite();
        await listMyInvites();
    }

    async function acceptInvite() {
        const id = $("invId").value.trim();
        await request("POST", `/api/group-invites/${id}/accept`);
    }

    async function rejectInvite() {
        const id = $("invId").value.trim();
        await request("POST", `/api/group-invites/${id}/reject`);
    }

    async function fetchNotificationAndExtractRefId() {
        const qs = new URLSearchParams({ unreadOnly: "false", page: "0", size: "50" });
        const list = await request("GET", `/api/notifications?${qs.toString()}`);
        const notifId = Number($("invNotifId").value.trim());
        if (!list || !Array.isArray(list.content)) { ok("Notifications is not Page{content:[]}"); return; }
        const n = list.content.find(x => Number(x.id) === notifId);
        if (!n) { ok("Notification not found in first 50."); return; }
        if (n.refId == null) { ok("This notification has no refId."); return; }
        $("invId").value = String(n.refId);
        ok(`Inserted inviteId from notification.refId = ${n.refId}`);
    }

    // ===== Group tasks =====
    function gp() {
        const groupId = $("gtGroupId").value.trim();
        const page = $("gtPage").value.trim() || "0";
        const size = $("gtSize").value.trim() || "10";
        const qs = new URLSearchParams({ page, size });
        return { groupId, qs: qs.toString() };
    }

    async function assignGroupTask() {
        const groupId = $("gtGroupId").value.trim();
        const data = await request("POST", `/api/groups/${groupId}/tasks/assign`, {
            assigneeUsername: $("gtAssignee").value.trim(),
            title: $("gtTitle").value.trim(),
            description: $("gtDesc").value.trim() || null,
            priority: $("gtPriority").value || null,
            dueAt: $("gtDueAt").value.trim() || null,
            visibleInGroup: $("gtVisible").value === "true"
        });
        // single TaskResponseDto -> just render single row table
        renderTasksPage({content:[data], number:0, size:1, totalElements:1}, "groupTasksTable");
    }

    async function createForAll() {
        const groupId = $("gtGroupId").value.trim();
        const data = await request("POST", `/api/groups/${groupId}/tasks/for-all`, {
            title: $("gaTitle").value.trim(),
            description: $("gaDesc").value.trim() || null,
            priority: $("gaPriority").value || null,
            dueAt: $("gaDueAt").value.trim() || null
        });
        renderTasksPage({content:[data], number:0, size:1, totalElements:1}, "groupTasksTable");
    }

    async function setGroupTaskStatus() {
        const groupId = $("gtGroupId").value.trim();
        const taskId = $("gsTaskId").value.trim();
        await request("POST", `/api/groups/${groupId}/tasks/${taskId}/status`, {
            status: $("gsStatus").value
        });
    }

    async function updateGroupTask() {
        const groupId = $("gtGroupId").value.trim();
        const taskId = $("guTaskId").value.trim();

        const clearDueAtRaw = $("guClearDueAt").value;
        const clearDueAt = clearDueAtRaw === "" ? null : (clearDueAtRaw === "true");

        const visRaw = $("guVisible").value;
        const visibleInGroup = visRaw === "" ? null : (visRaw === "true");

        const dto = {
            title: $("guTitle").value.trim() || null,
            description: $("guDesc").value.trim() || null,
            status: $("guStatus").value || null,
            priority: $("guPriority").value || null,
            dueAt: $("guDueAt").value.trim() || null,
            clearDueAt,
            visibleInGroup
        };

        const data = await request("PUT", `/api/groups/${groupId}/tasks/${taskId}`, dto);
        renderTasksPage({content:[data], number:0, size:1, totalElements:1}, "groupTasksTable");
    }

    async function deleteGroupTask() {
        const groupId = $("gtGroupId").value.trim();
        const taskId = $("guTaskId").value.trim();
        await request("DELETE", `/api/groups/${groupId}/tasks/${taskId}`);
    }

    async function groupMine() {
        const { groupId, qs } = gp();
        const data = await request("GET", `/api/groups/${groupId}/tasks/mine?${qs}`);
        renderTasksPage(data, "groupTasksTable");
    }

    async function groupForAllList() {
        const { groupId, qs } = gp();
        const data = await request("GET", `/api/groups/${groupId}/tasks/for-all/list?${qs}`);
        renderTasksPage(data, "groupTasksTable");
    }

    async function groupVisible() {
        const { groupId, qs } = gp();
        const data = await request("GET", `/api/groups/${groupId}/tasks/visible?${qs}`);
        renderTasksPage(data, "groupTasksTable");
    }

    // ===== Notifications =====
    async function listNotifications() {
        const unreadOnly = $("nUnreadOnly").value;
        const page = $("nPage").value.trim() || "0";
        const size = $("nSize").value.trim() || "10";
        const qs = new URLSearchParams({ unreadOnly, page, size });
        const data = await request("GET", `/api/notifications?${qs.toString()}`);
        renderNotificationsPage(data);
    }

    async function unreadCount() {
        await request("GET", "/api/notifications/unread-count");
    }

    async function markRead() {
        await request("POST", "/api/notifications/mark-read", {
            notificationId: Number($("nId").value.trim())
        });
    }

    async function markAllRead() {
        await request("POST", "/api/notifications/mark-all-read");
    }

    function renderNotificationsPage(page){
        if (!page || !Array.isArray(page.content)) {
            ok("Notifications response is not Page{content:[]}");
            return;
        }
        renderTable("notificationsTable",
            [
                { label:"id", render: n => escapeHtml(n.id) },
                { label:"type", render: n => `<b>${escapeHtml(n.type)}</b>` },
                { label:"title/message", render: n =>
                        `<b>${escapeHtml(n.title)}</b><div class="muted" style="margin-top:4px">${escapeHtml(n.message||"")}</div>` },
                { label:"refId", render: n =>
                        n.refId == null ? "" : `<span>${escapeHtml(n.refId)}</span>
          <div class="btns" style="margin:6px 0 0">
            <button class="btn-sm" onclick="useNotifRef(${Number(n.id)}, ${Number(n.refId)})">Use</button>
          </div>` },
                { label:"createdAt", render: n => escapeHtml(n.createdAt||"") },
                { label:"read", render: n => n.read ? "true" : "<span class='badge-bad'>false</span>" },
            ],
            page.content
        );
        ok(`Rendered notifications (${page.content.length}).`);
    }

    function useNotifRef(notifId, refId){
        $("invNotifId").value = String(notifId);
        $("invId").value = String(refId);
        ok("Inserted invNotifId + inviteId from notification");
    }

    // ===== AI =====
    function aiFillExample() {
        $("aiCommand").value = "Сгенерируй 5 задач на сегодня: учеба, спорт, покупки. Поставь приоритеты и сроки.";
        $("aiScope").value = "PERSONAL";
        $("aiGroupId").value = "";
        $("aiMaxTasks").value = "5";
        ok("Example inserted");
    }

    function renderAiFromLastResponse() {
        renderAiTable(lastResponse);
    }

    async function aiSuggest() {
        const scope = $("aiScope").value;
        const groupIdRaw = $("aiGroupId").value.trim();
        const maxTasksRaw = $("aiMaxTasks").value.trim();

        const payload = {
            command: $("aiCommand").value.trim(),
            scope: scope || null,
            groupId: (scope === "GROUP" && groupIdRaw) ? Number(groupIdRaw) : null,
            maxTasks: maxTasksRaw ? Number(maxTasksRaw) : null
        };

        const data = await request("POST", "/api/ai/tasks/suggest", payload);
        renderAiTable(data);
    }

    function renderAiTable(data) {
        const box = $("aiTable");

        const tasks = data && Array.isArray(data.tasks) ? data.tasks : null;
        const summary = data && typeof data.summary === "string" ? data.summary : "";

        if (!tasks || tasks.length === 0) {
            lastAiSuggestions = [];
            box.innerHTML = `<div class="muted">Нет задач в ответе. Ожидалось: { "tasks": [...], "summary": "..." }</div>`;
            return;
        }

        lastAiSuggestions = tasks.map((t, idx) => ({
            _idx: idx,
            selected: true,
            title: t.title ?? "",
            description: t.description ?? null,
            priority: t.priority ?? null,
            dueAtIso: t.dueAtIso ?? ""
        }));

        const rows = lastAiSuggestions.map(t => `
      <tr>
        <td><input type="checkbox" data-ai-idx="${t._idx}" checked onchange="aiToggle(${t._idx}, this.checked)" /></td>
        <td><b>${escapeHtml(t.title)}</b><div class="muted" style="margin-top:4px">${escapeHtml(t.description || "")}</div></td>
        <td>${escapeHtml(t.priority || "")}</td>
        <td>${escapeHtml(t.dueAtIso || "")}</td>
      </tr>
    `).join("");

        box.innerHTML = `
      ${summary ? `<div class="muted" style="margin-bottom:10px"><b>Summary:</b> ${escapeHtml(summary)}</div>` : ""}
      <table class="table">
        <thead>
          <tr>
            <th>save</th>
            <th>task</th>
            <th>priority</th>
            <th>dueAtIso</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
        ok("Rendered AI suggestions");
    }

    function aiToggle(idx, checked) {
        const t = lastAiSuggestions.find(x => x._idx === idx);
        if (t) t.selected = !!checked;
    }

    function aiSelectAll(on) {
        lastAiSuggestions.forEach(t => t.selected = !!on);
        document.querySelectorAll('input[type="checkbox"][data-ai-idx]').forEach(cb => cb.checked = !!on);
        ok(on ? "Selected all" : "Unselected all");
    }

    async function aiCreateSelected() {
        const scope = $("aiScope").value;
        const groupId = $("aiGroupId").value.trim();

        const selected = lastAiSuggestions.filter(t => t.selected);
        if (selected.length === 0) { ok("Nothing selected"); return; }

        if (scope === "GROUP" && !groupId) { ok("Для GROUP нужен groupId"); return; }

        for (const t of selected) {
            const dueAt = (t.dueAtIso && t.dueAtIso.trim()) ? t.dueAtIso.trim() : null;

            if (scope === "PERSONAL") {
                await request("POST", "/api/tasks", {
                    title: t.title,
                    description: t.description || null,
                    priority: t.priority || null,
                    dueAt
                });
            } else {
                await request("POST", `/api/groups/${groupId}/tasks/for-all`, {
                    title: t.title,
                    description: t.description || null,
                    priority: t.priority || null,
                    dueAt
                });
            }
        }
        ok(`Created ${selected.length} task(s) in DB`);
    }

    // init
    loadState();
</script>
</body>
</html>
